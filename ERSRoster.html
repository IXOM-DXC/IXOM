<html>

<head>
    <script src='https://sdk-cdn.mypurecloud.com/javascript/228.0.0/purecloud-platform-client-v2.min.js'></script>
    <style>
        body {
          font-family: 'Segoe UI', sans-serif;
          background-color: #f7f9fc;
          margin: 0;
          padding: 40px;
          color: #333;
        }
      
        h2, h3 {
          color: #2c3e50;
        }
      
        .section {
          background: white;
          padding: 20px 30px;
          margin-bottom: 30px;
          border-radius: 10px;
          box-shadow: 0 2px 8px rgba(0, 0, 0, 0.06);
        }
      
        label {
          margin-right: 10px;
          font-weight: bold;
        }
      
        select {
          padding: 8px;
          margin-right: 20px;
          border-radius: 5px;
          border: 1px solid #ccc;
        }
      
        button {
          background-color: #0078d4;
          color: white;
          border: none;
          padding: 10px 20px;
          font-size: 15px;
          border-radius: 6px;
          cursor: pointer;
          transition: background-color 0.3s ease;
        }
      
        button:hover {
          background-color: #005ea0;
        }
      
        #selectedOutput {
          margin-top: 10px;
          font-style: italic;
          color: #2c3e50;
        }
      
        table {
          width: 100%;
          border-collapse: collapse;
          margin-top: 20px;
        }
      
        table, th, td {
          border: 1px solid #ddd;
        }
      
        th {
          background-color: #f1f3f5;
          text-align: left;
          padding: 10px;
        }
      
        td {
          padding: 10px;
        }
        th {
            background-color: #2e2e2e; /* dark gray header */
            color: #00d4c4; /* Teal text color from logo */
            text-transform: uppercase;
            font-weight: bold;
            letter-spacing: 0.5px;
            }
        table {
            background-color: #2b2b2b;
            color: white;
        }
        .agent-selects {
            display: flex;
            flex-wrap: wrap;
            align-items: center;
            gap: 12px;
            margin-bottom: 20px;
        }

        .agent-selects label {
            font-weight: bold;
            color: rgb(12, 11, 11);
        }

      </style>
 </head>

<body>
    <h2>ERS Team Members</h2>
    <h3>Current Assignment</h3>
    <p id="currentAssignment">Loading current assignment...</p>

    <h3>Assign Primary & Backup Agents</h3>
    <div class="agent-selects">
        <label for="primarySelect">Primary:</label>
        <select id="primarySelect"></select>

        <label for="secondarySelect">Backup:</label>
        <select id="secondarySelect"></select>
    </div>    
    <br><br>
    <!-- ðŸ”˜ The Button -->
    <button onclick="getSelectedAgents()">Submit Assignment</button>

    <p id="selectedOutput"></p> <!-- Optional: for showing result -->
    <table border="1">
        <thead>
            <tr>
                <th>Agent Name</th>
                <th>Mobile Phone</th>
                <th>Home Phone</th>
                <th>Work Phone</th>
                <th>Contact Order</th>
                <th>PIN Enabled</th>
            </tr>
        </thead>
        <tbody id="agentTableBody"></tbody>
    </table>
</body>
</html>
 
<script>
    const clientId ='22d6754e-41a1-4bfb-88c7-e754df06ad7b';//'eb29d535-e216-48f4-abea-484345c61b98';
    const redirectUri = 'http://127.0.0.1:5500/ERSRoster.html';//'https://ixom-dxc.github.io/IXOM/ERSRoster.html';
    let environment = 'mypurecloud.com.au';

    // Set Genesys Cloud objects
    const platformClient = require('platformClient');
    const client = platformClient.ApiClient.instance;
    const groupName = 'ERS';
    let organizationApi = new platformClient.OrganizationApi();
    let cachedTableId = null; 
    const tableName = 'ERS_Roster'; // Data Table name //ERS_Agent_Assignment
    const agentIdToEmailMap = {};

    client.setEnvironment(environment);

    //document.addEventListener('DOMContentLoaded', function () {
     //   client.loginImplicitGrant(clientId, redirectUri)
     //       .then(() => {
     //           organizationApi.getOrganizationsMe()
    //                .then((data) => {
    //                    populateParagraph(data)
    //                })
   //                 .catch((err) => {
     //                   console.log('There was a failure calling getOrganizationsMe');
     //                   console.error(err);
     //               });
    //        })
    //});

    
    function populateParagraph(data) {
        for (key in data) {
            console.log(key, data[key]);
            let textnode = document.createTextNode(key + ' : ' + data[key]);
            let br = document.createElement("br")
            document.getElementById("orgDetails").appendChild(textnode);
            document.getElementById("orgDetails").appendChild(br);
        }
    }
    async function getCurrentAssignment(tableId) {
        try {
            console.log("Executing getFullRow...............");

            const assignment = await getFullRowWithFetch(tableId, 'ERS');  // manual fetch function 
            console.log("assignment:", assignment);
            console.log("primaryId:", assignment.primaryId);
            console.log("secondaryId:", assignment.secondaryId);

            return assignment;
        } catch (err) {
            console.error("Error in getCurrentAssignment:", err);
            return null;
        }
    }

    async function getERSAttributesByEmail(email) {
            const architectApi = new platformClient.ArchitectApi();
            const tableName = 'ERS_Coordinator_Attributes';
            
            try {
                const tableId = await getDataTableIdByName(tableName);
                if (!tableId) throw new Error('Data Table ID not found');

                const options = {
                    pageNumber: 1,
                    pageSize: 25,
                    showbrief: false,
                    sortOrder: "ascending"
                };

                const result = await architectApi.getFlowsDatatableRows(tableId, options);

                // Search for the row matching the given email
                const row = result.entities.find(r => r.key === email);

                if (!row) {
                    console.warn(`No matching row found for email: ${email}`);
                    return {
                        contactOrder: 'Not Set',
                        pinEnabled: 'Not Set'
                    };
                }

                console.log(`Found row for ${email}:`, row);

                return {
                    contactOrder: row.ContactOrder || 'Not Set',
                    pinEnabled: row.PinEnabled != null ? row.PinEnabled : 'Not Set'
                };
            } catch (err) {
                console.error(`Failed to get attributes for ${email}:`, err);
                return {
                    contactOrder: 'Not Set',
                    pinEnabled: 'Not Set'
                };
            }
        }



    async function getDataTableIdByName(tableName) {
        const architectApi = new platformClient.ArchitectApi();
        const tables = await architectApi.getFlowsDatatables({ pageSize: 100 });

        const match = tables.entities.find(t => t.name === tableName);
        return match ? match.id : null;
    }



    async function getSelectedAgents() {
        const primarySelect = document.getElementById('primarySelect');
        const secondarySelect = document.getElementById('secondarySelect');
        

        const primaryId = primarySelect?.value;
        const secondaryId = secondarySelect?.value;

        const primaryEmail = agentIdToEmailMap[primaryId];
        const attr = await getERSAttributesByEmail(primaryEmail);

        console.log('Selected PrimaryEmail:', primaryEmail);
        console.log('Selected Primary:', primaryId);
        console.log('Selected Secondary:', secondaryId);
        console.log('Selected Contact order:', attr.contactOrder);        
        console.log('Selected PIN:', attr.pinEnabled);

        // Optional: show names
        const primaryName = document.getElementById('primarySelect').selectedOptions[0].text;
        const secondaryName = document.getElementById('secondarySelect').selectedOptions[0].text;
        document.getElementById('selectedOutput').innerText = 
            `Primary: ${primaryName} | Backup: ${secondaryName}`;

        saveAssignmentToDataTable(primaryId, secondaryId, attr.contactOrder, attr.pinEnabled);
    }

    async function getFullRow(tableId, rowId) {
        const client = platformClient.ApiClient.instance;

        try {
            // Ensure auth is applied manually
            const opts = {
                pathParams: {
                    datatableId: tableId,
                    rowId: rowId
                },
                queryParams: {
                    showbrief: false
                },
                headerParams: {},
                formParams: {},
                bodyParam: null,
                authNames: ['PureCloud Auth'], // FIXED HERE
                contentTypes: [],
                accepts: ['application/json']
            };

            console.log("Access Token:", client.authData.accessToken);
                
            const response = await client.callApi(
                '/api/v2/flows/datatables/{datatableId}/rows/{rowId}',
                'GET',
                opts.pathParams,
                opts.queryParams,
                opts.headerParams,
                opts.formParams,
                opts.bodyParam,
                opts.authNames,
                opts.contentTypes,
                opts.accepts
                );

                console.log("âœ… Full row response:", response);
            return response;
        } catch (err) {
            console.error("Error fetching full row:", err);
        return null;
    }
    }

    async function getFullRowWithFetch(tableId, rowId) {
        const token = platformClient.ApiClient.instance.authData.accessToken;

        const url = `https://api.mypurecloud.com.au/api/v2/flows/datatables/${tableId}/rows/${rowId}?showbrief=false`;

        const response = await fetch(url, {
            headers: {
            'Authorization': `Bearer ${token}`,
            'Accept': 'application/json'
            }
        });

        if (!response.ok) {
            const error = await response.text();
            throw new Error(`Fetch failed: ${response.status} ${response.statusText} â€” ${error}`);
        }

        const data = await response.json();
        console.log("âœ… Full row via fetch():", data);
        return data;
    }

    async function authenticate() {
        client.setEnvironment('mypurecloud.com.au'); 
        await client.loginImplicitGrant(clientId, redirectUri);
        console.log('Authenticated');
        const api = new platformClient.ArchitectApi();
        const tableId ='1ff19aee-a309-4a86-9c81-b067ab60331c';// '2127052b-afb7-47ac-b274-467a6377c4e0'; 

        api.getFlowsDatatableRow(tableId, 'ERS').then(row => {
            console.log("Full ERS row:", row);
        });

        await loadRaiseTeam(tableId);
        await listDataTables();
    }
   
    async function loadRaiseTeam(tableId) {
        const groupsApi = new platformClient.GroupsApi();
        const usersApi = new platformClient.UsersApi();

        // Step 1: Find the ERS group
        const groupSearch = await groupsApi.getGroups({ name: groupName });
        const raiseGroup = groupSearch.entities.find(g => g.name === groupName);
        if (!raiseGroup) {
            alert('RAISE group not found');
            return;
        }
        // Step 2: Get group members
        const members = await groupsApi.getGroupMembers(raiseGroup.id);
        console.log('Table element:', document.getElementById('agentTableBody'));
        let tbody = document.getElementById('agentTableBody');
        tbody.innerHTML = ''; // clear previous rows

        const primaryDropdown = document.getElementById('primarySelect');
        const secondaryDropdown = document.getElementById('secondarySelect');
        
        // Clear any previous options
        primaryDropdown.innerHTML = '';
        secondaryDropdown.innerHTML = '';

        const agentMap = {}; // id => name map

        console.log(`Members in group: ${members.entities.length}`);
        // Step 3: Fetch and display each agent's contact info
        for (const member of members.entities) {
            const user = await usersApi.getUser(member.id);
            agentMap[user.id] = user.name;
            agentIdToEmailMap[user.id] = user.email;

            const cell = user.addresses?.find(a => a.type === 'MOBILE' && a.mediaType === 'PHONE')?.address || '';
            const home = user.addresses?.find(a => a.type === 'HOME' && a.mediaType === 'PHONE')?.address || '';
            const work = user.addresses?.find(a => a.type === 'WORK' && a.mediaType === 'PHONE')?.address || '';

            // Get ERS attributes from Data Table using user.email
             console.log('Email:', user.email);
            const ersParams = await getERSAttributesByEmail(user.email);
            const contactOrder = ersParams.contactOrder;
            const enablePin = ersParams.pinEnabled;

            console.log(`Agent: ${user.name}, Contact Order: ${ersParams.contactOrder}, PIN Enabled: ${ersParams.pinEnabled}`);
            console.log('Work Phone:', work);
            console.log('Mobile Phone:', cell);
            console.log('Home Phone:', home);

            // Add agent to dropdowns
            const option1 = new Option(user.name, user.id);
            const option2 = new Option(user.name, user.id);
            primaryDropdown.add(option1);
            secondaryDropdown.add(option2);
            
            setupDropdownLogic();

            const row = document.createElement('tr');
            row.innerHTML = `
                <td>${user.name}</td>
                <td>${cell}</td>
                <td>${home}</td>
                <td>${work}</td>
                <td>${contactOrder}</td>
                <td>${enablePin}</td>
                `;
            tbody.appendChild(row); // inside the loop
        }
        console.log("Full agent map:", agentMap);
        console.log('Agent ID to Email Map:', agentIdToEmailMap);

        const assignment = await getCurrentAssignment(tableId);
        if (assignment?.primaryId && assignment?.secondaryId) {
            document.getElementById('primarySelect').value = assignment.primaryId;
            document.getElementById('secondarySelect').value = assignment.secondaryId;

            const primaryName = agentMap[assignment.primaryId] || `ID: ${assignment.primaryId}`;
            const secondaryName = agentMap[assignment.secondaryId] || `ID: ${assignment.secondaryId}`;

            document.getElementById('currentAssignment').innerText =
            `Primary: ${primaryName} | Backup: ${secondaryName}`;
        } 
        else {
            document.getElementById('currentAssignment').innerText = 'No current assignment found in Data Table.';
        }
    }
    function setupDropdownLogic() {
        const primarySelect = document.getElementById('primarySelect');
        const secondarySelect = document.getElementById('secondarySelect');

        primarySelect.addEventListener('change', () => {
            const selectedPrimary = primarySelect.value;
            Array.from(secondarySelect.options).forEach(option => {
            option.disabled = option.value === selectedPrimary;
            });
        });

        secondarySelect.addEventListener('change', () => {
            const selectedSecondary = secondarySelect.value;
            Array.from(primarySelect.options).forEach(option => {
            option.disabled = option.value === selectedSecondary;
            });
        });

        // Trigger once if values are already set
        primarySelect.dispatchEvent(new Event('change'));
        secondarySelect.dispatchEvent(new Event('change'));
    }

   
    async function getTableIdByName(tableName) {
       if (cachedTableId) {
           return cachedTableId; // return the cached ID if we already found it
       }
       const architectApi = new platformClient.ArchitectApi();

       try {
           const response = await architectApi.getFlowsDatatables({ pageSize: 100 });
           const match = response.entities.find(table => table.name === tableName);

           if (match) {
               console.log(`Found table "${tableName}" â†’ ID: ${match.id}`);
               cachedTableId = match.id; // cache it for future use
               return cachedTableId;
           } 
           else {
               console.error(`Table "${tableName}" not found.`);
               return null;
           }
       } 
       catch (error) {
           console.error('Error retrieving table list:', error);
           return null;
       }
    }
   
   async function saveAssignmentToDataTable(primaryId, secondaryId, contactOrder, pinEnabled) {
       const architectApi = new platformClient.ArchitectApi();
       //const tableName = 'ERS_Agent_Assignment'; // table name 
       const tables = await architectApi.getFlowsDatatables();  // paged list
       console.log(tables);

       const tableId = await getTableIdByName(tableName); //'2127052b-afb7-47ac-b274-467a6377c4e0';
       
       const rowId = 'ERS'; // Fixed key, or make it dynamic if needed

       const row = {
           key: rowId, // must match the key column name
           primaryId: primaryId,
           secondaryId: secondaryId,
           contactOrder: contactOrder,   // <-- to be fetched
           enablePin:String(pinEnabled),         // <-- to be fetched
           timestamp: new Date().toLocaleString('en-AU', {
                year: 'numeric',
                month: '2-digit',
                day: '2-digit',
                hour: '2-digit',
                minute: '2-digit',
                second: '2-digit',
                hour12: false
            }
           )
       };

       console.log('Sending row:', JSON.stringify(row, null, 2));

       try {
           await architectApi.deleteFlowsDatatableRow(tableId, "ERS");
           // Save or update the row
           const result = await architectApi.postFlowsDatatableRows(tableId, row);
           console.log('Assignment saved to data table.', result);
           document.getElementById('selectedOutput').innerText += "\n(Saved to Data Table)";
           const primaryName = document.getElementById('primarySelect').selectedOptions[0].text;
            const secondaryName = document.getElementById('secondarySelect').selectedOptions[0].text;

            document.getElementById('currentAssignment').innerText =  `Primary: ${primaryName} | Secondary: ${secondaryName}`;
            document.getElementById('selectedOutput').innerText =  `âœ… Assignment saved!\n`;

       } catch (error) {
           console.error('Failed to save to data table:', error);
           console.error('Status:', error.status);
           console.error('Message:', error.body?.message);
           console.error('Details:', JSON.stringify(error.body?.details, null, 2));
           alert("Error saving to Data Table. Check console for details.");
       }
    }
    async function listDataTables() {
        const architectApi = new platformClient.ArchitectApi();

        try {
            const response = await architectApi.getFlowsDatatables({ pageSize: 100 }); // fetch all
            response.entities.forEach((table) => {
                //console.log(`ðŸ“˜ Table Name: "${table.name}" â€” ID: ${table.id}`);
            });
        } catch (err) {
            console.error("Failed to fetch data tables:", err);
        }
    }

   authenticate();
</script>